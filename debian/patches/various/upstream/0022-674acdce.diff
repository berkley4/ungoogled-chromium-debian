From 674acdcee0c59128cdc02e28903099911007244b Mon Sep 17 00:00:00 2001
From: Kent Tamura <tkent@chromium.org>
Date: Wed, 29 May 2024 05:23:27 +0000
Subject: [PATCH] RubyLB: Fix a crash by a pseudo element with float

Bug: 343069826
Change-Id: I1b105ead86148a91f697b6188c24c28753d44f04
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5579075
Commit-Queue: Koji Ishii <kojii@chromium.org>
Auto-Submit: Kent Tamura <tkent@chromium.org>
Reviewed-by: Koji Ishii <kojii@chromium.org>
Cr-Commit-Position: refs/heads/main@{#1307223}
---

--- a/third_party/blink/renderer/core/css/resolver/style_adjuster.cc
+++ b/third_party/blink/renderer/core/css/resolver/style_adjuster.cc
@@ -646,12 +646,15 @@
     if (RuntimeEnabledFeatures::RubyLineBreakableEnabled() &&
         builder.IsFloating()) {
       builder.SetFloating(EFloat::kNone);
-      element->GetDocument().AddConsoleMessage(
-          MakeGarbageCollected<ConsoleMessage>(
-              ConsoleMessage::Source::kRendering, ConsoleMessage::Level::kInfo,
-              "`float` property is not supported correctly inside an element "
-              "with `display: ruby` or `display: ruby-text`."),
-          true);
+      if (document) {
+        document->AddConsoleMessage(
+            MakeGarbageCollected<ConsoleMessage>(
+                ConsoleMessage::Source::kRendering,
+                ConsoleMessage::Level::kInfo,
+                "`float` property is not supported correctly inside an element "
+                "with `display: ruby` or `display: ruby-text`."),
+            true);
+      }
     }
     if (!builder.IsFloating()) {
       builder.SetIsInInlinifyingDisplay();
--- /dev/null
+++ b/third_party/blink/web_tests/fast/ruby/float-in-pseudo-crash.html
@@ -0,0 +1,15 @@
+<!DOCTYPE html>
+<script src="../../resources/testharness.js"></script>
+<script src="../../resources/testharnessreport.js"></script>
+<style>
+ruby::before {
+  content: '';
+  float: right;
+}
+</style>
+<ruby></ruby>
+<script>
+test(() => {
+  document.querySelector('ruby').getBoundingClientRect();
+}, 'crbug.com/343069826: Float in a pseudo element should not cause a crash');
+</script>
